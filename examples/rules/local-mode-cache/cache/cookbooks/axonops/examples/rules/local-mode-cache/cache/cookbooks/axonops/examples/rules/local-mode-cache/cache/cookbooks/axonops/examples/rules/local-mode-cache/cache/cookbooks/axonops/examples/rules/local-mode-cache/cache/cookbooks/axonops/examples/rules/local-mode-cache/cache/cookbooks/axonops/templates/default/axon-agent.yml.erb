# AxonOps Agent Configuration
# Generated by Chef - Local modifications will be overwritten
<% if defined?(@agent_host) && !@agent_host.nil? %>
axon-server:
  hosts: <%= @agent_host %>
  <% if defined?(@agent_port) && !@agent_port.nil? %>
  port: <%= @agent_port || 1888 %>
  <% end %>
<% end %>

axon-agent:
<% if !defined?(@agent_host) || @agent_host.nil? %>
  prom_only: true
<% end %>
  org: "<%= @org_name %>"
<% if defined?(@org_key) && !@org_key.nil? %>
  key: <%= @org_key %>
<% end %>
<% if defined?(@org_agent_hostname) && !@org_agent_hostname.nil? %>
  host_name: "<%= @org_agent_hostname %>"
<% end %>
<% if defined?(@cluster_name) && !@cluster_name.nil? %>
  cluster_name: "<%= @cluster_name %>"
<% end %>
<% if defined?(@human_readable_identifier) && !@human_readable_identifier.nil? %>
  human_readable_identifier: "<%= @human_readable_identifier %>"
<% end %>
<% if defined?(@force_send_all_metrics_prom) && !@force_send_all_metrics_prom.nil? %>
  force_send_all_metrics_prom: true
<% end %>
<% if defined?(@tmp_path) && !@tmp_path.nil? && @tmp_path != "" %>
  tmp_path: "<%= @tmp_path %>"
<% end %>
<% if defined?(@tls_mode) && !@tls_mode.nil? && @tls_mode != '' %>
  tls:
    mode: "<%= @tls_mode %>" # disabled, TLS, mTLS
  <% if @tls_mode == "TLS" || @tls_mode == "mTLS" %>
    skipVerify: <%= @tls_skipverify || 'false' %>
    <% if defined?(@tls_cafile) && !@tls_cafile.nil? %>
    caFile: "<%= @tls_cafile %>"
    <% end %>
  <% end %>
  <% if defined?(@tls_mode) && @tls_mode == "mTLS" %>
    certFile: "<%= @tls_certfile %>"
    keyFile: "<%= @tls_keyfile %>"
  <% end %>
<% end %>
<% if defined?(@backup_purge_interval) && !@backup_purge_interval.nil? %>
  backup_purge_interval: "<%= @backup_purge_interval %>"
<% end %>
  disable_command_exec: <%= (defined?(@disable_command_exec) && !@disable_command_exec.nil?) ? @disable_command_exec : false %>
  scripts_location: <%= (defined?(@scripts_location) && !@scripts_location.nil?) ? @scripts_location : '/var/lib/axonops/scripts/' %>

NTP:
  host: "<%= @ntp_server %>" # Specify your NTP server IP address or hostname
  timeout: <%= @ntp_timeout || 6 %>

<% if defined?(@include_service_config) && @include_service_config %>
  <% if @pkg.start_with?('axon-dse') %>
<%= (defined?(@upper_lower_case_dse_template_var) && !@upper_lower_case_dse_template_var.nil?) ? @upper_lower_case_dse_template_var : 'dse' %>:
    tier0: # metrics collected every 5 seconds
      metrics:
        jvm_:
          - "java.lang:*"
        cas_:
          - "org.apache.cassandra.metrics:*"
          - "org.apache.cassandra.net:type=FailureDetector"
          - "com.datastax.bdp:type=dsefs,*"
          - "com.datastax.bdp:type=metrics,*"
    tier1:
      frequency: 300 # metrics collected every 300 seconds (5m)
      metrics:
        cas_:
          #- "org.apache.cassandra.metrics:name=EstimatedPartitionSizeHistogram,*"
          - "org.apache.cassandra.metrics:name=EstimatedPartitionCount,*"
          #- "org.apache.cassandra.metrics:name=EstimatedColumnCountHistogram,*"

    #tier2:
    #  frequency: 3600 # 1h

    #tier3:
    #  frequency: 86400 # 1d

    blacklist: # You can blacklist metrics based on Regex pattern. Hit the agent on http://agentIP:9916/metricslist to list JMX metrics it is collecting
      - "org.apache.cassandra.metrics:type=ColumnFamily.*" # duplication of table metrics
      - "org.apache.cassandra.metrics:.*scope=Repair#.*" # ignore each repair instance metrics
      - "org.apache.cassandra.metrics:.*name=SnapshotsSize.*" # Collecting SnapshotsSize metrics slows down collection
      - "org.apache.cassandra.metrics:.*Max.*"
      - "org.apache.cassandra.metrics:.*Min.*"
      - "com.datastax.bdp:.*Max.*"
      - "com.datastax.bdp:.*Min.*"
      - ".*999thPercentile|.*50thPercentile|.*FifteenMinuteRate|.*FiveMinuteRate|.*MeanRate|.*Mean|.*OneMinuteRate|.*StdDev"
    JMXOperationsBlacklist:
      - "getThreadInfo"
      - "getDatacenter"
      - "getRack"
    DMLEventsWhitelist: # You can whitelist keyspaces / tables (list of "keyspace" and/or "keyspace.table" to log DML queries. Data is not analysed.
    # - "system_distributed"
    DMLEventsBlacklist: # You can blacklist keyspaces / tables from the DMLEventsWhitelist (list of "keyspace" and/or "keyspace.table" to log DML queries. Data is not analysed.
    # - system_distributed.parent_repair_history
    logSuccessfulRepairs: false # set it to true if you want to log all the successful repair events.
    #nodetoolPath : "/path/to/nodetool"
    warningThresholdMillis: 200 # This will warn in logs when a MBean takes longer than the specified value.
    logFormat: "%4$s %1$tY-%1$tm-%1$td %1$tH:%1$tM:%1$tS,%1$tL %5$s%6$s%n"
  <% elsif @pkg.include?("axon-cassandra") %>
cassandra:
    tier0: # metrics collected every 5 seconds
      metrics:
        jvm_:
          - "java.lang:*"
        cas_:
          - "org.apache.cassandra.metrics:*"
          - "org.apache.cassandra.net:type=FailureDetector"

    tier1:
      frequency: 300 # metrics collected every 300 seconds (5m)
      metrics:
        cas_:
          #- "org.apache.cassandra.metrics:name=EstimatedPartitionSizeHistogram,*"
          - "org.apache.cassandra.metrics:name=EstimatedPartitionCount,*"
          #- "org.apache.cassandra.metrics:name=EstimatedColumnCountHistogram,*"

    #tier2:
    #  frequency: 3600 # 1h

    #tier3:
    #  frequency: 86400 # 1d

    blacklist: # You can blacklist metrics based on Regex pattern. Hit the agent on http://agentIP:9916/metricslist to list JMX metrics it is collecting
      - "org.apache.cassandra.metrics:type=ColumnFamily.*" # duplication of table metrics
      - "org.apache.cassandra.metrics:.*scope=Repair#.*" # ignore each repair instance metrics
      - "org.apache.cassandra.metrics:.*name=SnapshotsSize.*" # Collecting SnapshotsSize metrics slows down collection
      - "org.apache.cassandra.metrics:.*Max.*"
      - "org.apache.cassandra.metrics:.*Min.*"
      - ".*999thPercentile|.*50thPercentile|.*FifteenMinuteRate|.*FiveMinuteRate|.*MeanRate|.*Mean|.*OneMinuteRate|.*StdDev"

    DMLEventsWhitelist: # You can whitelist keyspaces / tables (list of "keyspace" and/or "keyspace.table" to log DML queries. Data is not analysed.
      - "system_distributed"

    JMXOperationsBlacklist:
      - "getThreadInfo"
      - "getDatacenter"
      - "getRack"

    logSuccessfulRepairs: false # set it to true if you want to log all the successful repair events.

    warningThresholdMillis: <%= @warn_threshold_millis || 1000 %> # This will warn in logs when a MBean takes longer than the specified value.

    logFormat: "%4$s %1$tY-%1$tm-%1$td %1$tH:%1$tM:%1$tS,%1$tL %5$s%6$s%n"
  <% end %>
<% end %>