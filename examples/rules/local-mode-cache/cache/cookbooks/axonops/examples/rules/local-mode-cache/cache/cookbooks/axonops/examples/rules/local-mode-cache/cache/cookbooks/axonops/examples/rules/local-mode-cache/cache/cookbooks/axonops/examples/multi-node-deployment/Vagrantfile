# -*- mode: ruby -*-
# vi: set ft=ruby :

# Multi-node AxonOps deployment example
# This Vagrantfile creates two VMs:
# 1. axonops-server: Complete AxonOps stack (server, dashboard, storage)
# 2. cassandra-app: Apache Cassandra 5.0 with AxonOps agent

Vagrant.configure("2") do |config|
  # Use Ubuntu 22.04 for both VMs
  config.vm.box = "bento/ubuntu-22.04"
  
  # AxonOps Server VM
  config.vm.define "axonops-server" do |server|
    server.vm.hostname = "axonops-server"
    server.vm.network "private_network", ip: "192.168.56.10"
    
    server.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
      vb.name = "axonops-server"
    end
    
    # Port forwarding for access from host
    server.vm.network "forwarded_port", guest: 3000, host: 3000  # Dashboard
    server.vm.network "forwarded_port", guest: 8080, host: 8080  # API
    
    server.vm.provision "chef_solo" do |chef|
      chef.cookbooks_path = "../../"
      chef.add_recipe "axonops::multi_node_axonops"
      chef.json = {
        "axonops" => {
          "deployment_mode" => "self-hosted",
          "multi_node" => {
            "role" => "server",
            "server_ip" => "192.168.56.10"
          },
          "server" => {
            "enabled" => true,
            "listen_address" => "0.0.0.0"
          },
          "dashboard" => {
            "enabled" => true,
            "listen_address" => "0.0.0.0"
          }
        }
      }
    end
  end
  
  # Cassandra Application VM
  config.vm.define "cassandra-app" do |cass|
    cass.vm.hostname = "cassandra-app"
    cass.vm.network "private_network", ip: "192.168.56.20"
    
    cass.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
      vb.name = "cassandra-app"
    end
    
    cass.vm.provision "chef_solo" do |chef|
      chef.cookbooks_path = "../../"
      chef.add_recipe "axonops::multi_node_cassandra"
      chef.json = {
        "cassandra" => {
          "install" => true,
          "force_fresh_install" => true,
          "cluster_name" => "Test Application Cluster",
          "listen_address" => "192.168.56.20",
          "rpc_address" => "192.168.56.20",
          "seeds" => ["192.168.56.20"]
        },
        "axonops" => {
          "agent" => {
            "enabled" => true
          },
          "multi_node" => {
            "role" => "cassandra",
            "server_ip" => "192.168.56.10"
          }
        }
      }
    end
  end
  
  # Common VM settings
  config.vm.provider "virtualbox" do |vb|
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--ioapic", "on"]
  end
  
  # Install Chef if not present
  config.omnibus.chef_version = :latest
  
  # Display information after provisioning
  config.vm.provision "shell", inline: <<-SHELL
    echo "======================================================"
    echo "Multi-node AxonOps deployment complete!"
    echo "======================================================"
    echo "AxonOps Dashboard: http://192.168.56.10:3000"
    echo "         or        http://localhost:3000"
    echo "AxonOps API:       http://192.168.56.10:8080"
    echo "         or        http://localhost:8080"
    echo "Cassandra CQL:     192.168.56.20:9042"
    echo "======================================================"
    echo "To connect:"
    echo "  vagrant ssh axonops-server"
    echo "  vagrant ssh cassandra-app"
    echo "======================================================"
  SHELL
end