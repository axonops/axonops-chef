name: Chef Unit Tests

on:
  push:
    branches: [ main, develop, test_units ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true # runs 'bundle install' and caches installed gems automatically

    - name: Run RuboCop (linting)
      run: |
        export CHEF_LICENSE=accept-silent
        export PATH=/opt/hostedtoolcache/Ruby/3.1.7/x64/bin:$PATH
        chef exec rubocop --display-cop-names --extra-details
      continue-on-error: true

    - name: Run ChefSpec unit tests
      run: |
        export CHEF_LICENSE=accept-silent
        export PATH=/opt/hostedtoolcache/Ruby/3.1.7/x64/bin:$PATH
        find /opt -name chef -type f
        chef exec rspec spec/unit/recipes/alert_rules_spec.rb --format documentation --color

    - name: Run all unit tests
      run: |
        export CHEF_LICENSE=accept-silent
        export PATH=/opt/hostedtoolcache/Ruby/3.1.7/x64/bin:$PATH
        chef exec rspec --format documentation --color

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: rspec-results-ruby-chef
        path: |
          coverage/
          .rspec_status

  cookstyle:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Install dependencies
      run: |
        gem install cookstyle
        gem install chef

    - name: Run Cookstyle
      run: cookstyle --display-cop-names --extra-details
      continue-on-error: true

  foodcritic:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Install dependencies
      run: |
        gem install foodcritic
        gem install chef

    - name: Run Foodcritic
      run: foodcritic . -f any -t ~FC121 -t ~FC034
      continue-on-error: true
