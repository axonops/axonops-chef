# AxonOps Server Configuration
# Generated by Chef - Local modifications will be overwritten

server:
  host: <%= @listen_address %>
  port: <%= @listen_port %>

<% if @use_new_format -%>
# New format for axon-server >= 2.0.4
search_db:
  hosts:
<% @search_db_hosts.each do |host| -%>
    - <%= host %>
<% end -%>
<% if @search_db_username -%>
  username: <%= @search_db_username %>
<% end -%>
<% if @search_db_password -%>
  password: <%= @search_db_password %>
<% end -%>
<% if @search_db_skip_verify -%>
  skip_verify: <%= @search_db_skip_verify %>
<% end -%>
<% if @search_db_replicas -%>
  replicas: <%= @search_db_replicas %>
<% end -%>
<% if @search_db_shards -%>
  shards: <%= @search_db_shards %>
<% end -%>
<% else -%>
# Old format for axon-server < 2.0.4
elastic_host: <%= @elastic_host %>
elastic_port: <%= @elastic_port %>
<% end -%>

cql_hosts:
<% @cassandra_hosts.each do |host| -%>
  - "<%= host %>"
<% end -%>
cql_username: "<%= @cassandra_username %>"
cql_password: "<%= @cassandra_password %>"
cql_local_dc: "<%= @cassandra_dc %>"
cql_ssl: <%= node['axonops']['cassandra']['ssl']['enabled'] %>
cql_skip_verify: <%= node['axonops']['cassandra']['ssl']['cql_skip_verify'] || true %>
<% if node['axonops']['cassandra']['ssl']['ca_file'] %>
cql_ca_file: <%= node['axonops']['cassandra']['ssl']['ca_file'] %>
<% end %>
<% if node['axonops']['cassandra']['ssl']['cert_file'] && node['axonops']['cassandra']['ssl']['key_file'] %>
cql_cert_file: <%= node['axonops']['cassandra']['ssl']['cert_file'] %>
cql_key_file: <%= node['axonops']['cassandra']['ssl']['key_file'] %>
<% end %>
cql_autocreate_tables: <%= node['axonops']['cassandra']['ssl']['autocreate_tables'] || true %>
cql_keyspace_replication: "<%= node['axonops']['server']['cassandra']['keyspace_replication'] %>"
cql_read_consistency: <%= node['axonops']['cassandra']['ssl']['read_consistency'] || "LOCAL_ONE" %>
cql_write_consistency: <%= node['axonops']['cassandra']['ssl']['read_consistency'] || "WRITE_ONE" %>

<% if @tls_mode != 'disabled' -%>
tls:
  mode: <%= @tls_mode %>
<% if @tls_cert_file -%>
  certFile: <%= @tls_cert_file %>
<% end -%>
<% if @tls_key_file -%>
  keyFile: <%= @tls_key_file %>
<% end -%>
<% if @tls_ca_file && @tls_mode == 'mTLS' -%>
  caFile: <%= @tls_ca_file %>
<% end -%>
<% end -%>

retention:
  events: <%= @retention['events'] %>
  security_events: <%= @retention['security_events'] %>

  metrics:
    high_resolution: <%= @retention['metrics']['high_resolution'] %>
    medium_resolution: <%= @retention['metrics']['medium_resolution'] %>
    low_resolution: <%= @retention['metrics']['low_resolution'] %>
    super_low_resolution: <%= @retention['metrics']['super_low_resolution'] %>

  backups:
    local: <%= @retention['backups']['local'] %>
    remote: <%= @retention['backups']['remote'] %>

alert_log:
  enabled: <%= node['axonops']['server']['alert_log']['enabled'] %>
  path: <%= node['axonops']['server']['alert_log']['path'] %>
  max_size_mb: <%= node['axonops']['server']['alert_log']['max_size_mb'] %>
  max_files: <%= node['axonops']['server']['alert_log']['max_files'] %>

<% if node['axonops']['server']['auth']['enabled'] -%>
# LDAP Authentication Configuration
auth:
  enabled: true
  type: "<%= node['axonops']['server']['auth']['type'] %>"
  settings:
    base: <%= node['axonops']['server']['auth']['base'] %>
    bindDN: <%= node['axonops']['server']['auth']['bind_dn'] %>
    bindPassword: <%= node['axonops']['server']['auth']['bind_password'] %>
    host: <%= node['axonops']['server']['auth']['host'] %>
    port: <%= node['axonops']['server']['auth']['port'] %>
    rolesAttribute: <%= node['axonops']['server']['auth']['roles_attribute'] %>
    rolesMapping:
<% node['axonops']['server']['auth']['roles_mapping'].each do |scope, roles| -%>
      <%= scope %>:
<% roles.each do |role_type, role_dn| -%>
        <%= role_type %>: <%= role_dn %>
<% end -%>
<% end -%>
    useSSL: <%= node['axonops']['server']['auth']['use_ssl'] %>
    userFilter: <%= node['axonops']['server']['auth']['user_filter'] %>
<% end -%>
